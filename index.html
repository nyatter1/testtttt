<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Clone Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#000000',
                        glass: 'rgba(255, 255, 255, 0.08)',
                        glassBorder: 'rgba(255, 255, 255, 0.12)',
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(29, 78, 216, 0.15), transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.15), transparent 20%);
            background-attachment: fixed;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Effects */
        .glass-panel {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glassBorder);
        }

        .effect-rainbow {
            background: linear-gradient(to right, #ef4444, #eab308, #22c55e, #3b82f6, #a855f7);
            -webkit-background-clip: text; color: transparent; background-size: 200% auto; animation: rainbow 3s linear infinite;
        }
        @keyframes rainbow { to { background-position: 200% center; } }

        .effect-glow { text-shadow: 0 0 12px currentColor; }
        .effect-fire { 
            background: linear-gradient(0deg, #ff0000 0%, #ffff00 100%); 
            -webkit-background-clip: text; color: transparent; 
            text-shadow: 0 -2px 10px rgba(255, 0, 0, 0.5); 
        }
        .effect-glitch { position: relative; }
        .effect-glitch::before, .effect-glitch::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; opacity: 0.8;
        }
        .effect-glitch::before { color: #0ff; z-index: -1; animation: glitch 0.3s infinite; clip-path: inset(0 0 60% 0); transform: translate(-2px, 0); }
        .effect-glitch::after { color: #f0f; z-index: -2; animation: glitch 0.3s infinite reverse; clip-path: inset(40% 0 0 0); transform: translate(2px, 0); }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 100% { transform: translate(0); } }

        .loader {
            width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* File Upload Hidden */
        input[type="file"] { display: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="antialiased text-slate-200">

    <div id="app" class="flex justify-center min-h-screen"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYI4Avd42wjJa3YOSKuGHhSCGgLFLZvik",
            authDomain: "presently-3babd.firebaseapp.com",
            projectId: "presently-3babd",
            storageBucket: "presently-3babd.firebasestorage.app",
            messagingSenderId: "646349632966",
            appId: "1:646349632966:web:0a1051f7ece29d9542aec7",
            measurementId: "G-SJP7NQZEQJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Config ---
        const COLORS = ["#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899", "#06b6d4", "#ffffff", "#a855f7", "#eab308"];
        const EFFECTS = [
            { id: 'none', label: 'None' },
            { id: 'rainbow', label: 'Prismatic' },
            { id: 'glow', label: 'Neon Glow' },
            { id: 'glitch', label: 'Cyberpunk' },
            { id: 'fire', label: 'Inferno' }
        ];
        const GRADIENTS = [
            { id: 'none', label: 'Solid', class: '' },
            { id: 'sunset', label: 'Sunset', class: 'bg-gradient-to-r from-orange-500 to-pink-600' },
            { id: 'ocean', label: 'Ocean', class: 'bg-gradient-to-r from-cyan-400 to-blue-600' },
            { id: 'royal', label: 'Royal', class: 'bg-gradient-to-r from-purple-500 to-indigo-600' },
            { id: 'emerald', label: 'Emerald', class: 'bg-gradient-to-r from-emerald-400 to-green-600' },
            { id: 'gold', label: 'Gold', class: 'bg-gradient-to-r from-yellow-300 to-amber-600' }
        ];

        // --- Global State ---
        let currentUser = JSON.parse(localStorage.getItem('user_session')) || null;
        let tweets = [];
        let usersCache = {};
        let currentRoute = 'feed';
        let profileTarget = null;
        let unsubTweets = null;
        let unsubUser = null;

        // --- Helpers ---
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- Core Logic ---

        async function login(username, password) {
            try {
                const docSnap = await getDoc(doc(db, "users", username));
                if (docSnap.exists() && docSnap.data().password === password) {
                    currentUser = docSnap.data();
                    localStorage.setItem('user_session', JSON.stringify(currentUser));
                    initApp();
                    return { success: true };
                }
                return { error: "Invalid credentials" };
            } catch (e) { return { error: e.message }; }
        }

        async function signup(username, password, name) {
            try {
                const docRef = doc(db, "users", username);
                if ((await getDoc(docRef)).exists()) return { error: "Username taken" };
                
                const newUser = {
                    username, password, name,
                    bio: "New to the Ultraverse.",
                    pfp: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`,
                    banner: `https://picsum.photos/seed/${username}/800/300`,
                    color: '#3b82f6', effect: 'none', gradient: 'none',
                    following: [], followers: [], joined: new Date().toISOString()
                };
                
                await setDoc(docRef, newUser);
                currentUser = newUser;
                localStorage.setItem('user_session', JSON.stringify(currentUser));
                initApp();
                return { success: true };
            } catch (e) { return { error: "Signup failed" }; }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user_session');
            if (unsubTweets) unsubTweets();
            if (unsubUser) unsubUser();
            renderAuth();
        }

        async function postTweet(content, image) {
            if (!content && !image) return;
            await addDoc(collection(db, "tweets"), {
                author: currentUser.username,
                content, image,
                likes: [], comments: [],
                timestamp: new Date().toISOString()
            });
        }

        async function addComment(tweetId, content) {
            if (!content.trim()) return;
            const ref = doc(db, "tweets", tweetId);
            const comment = {
                author: currentUser.username,
                content,
                timestamp: new Date().toISOString()
            };
            await updateDoc(ref, { comments: arrayUnion(comment) });
        }

        async function toggleFollow(targetUsername) {
            if (targetUsername === currentUser.username) return;

            const myRef = doc(db, "users", currentUser.username);
            const targetRef = doc(db, "users", targetUsername);
            const isFollowing = currentUser.following.includes(targetUsername);

            try {
                // Optimistic UI update for Current User
                if (isFollowing) {
                    currentUser.following = currentUser.following.filter(u => u !== targetUsername);
                } else {
                    currentUser.following.push(targetUsername);
                }
                
                // Optimistic UI update for Target User (Follower Count)
                if (usersCache[targetUsername]) {
                    const tUser = usersCache[targetUsername];
                    if(!tUser.followers) tUser.followers = [];
                    if(isFollowing) {
                        tUser.followers = tUser.followers.filter(u => u !== currentUser.username);
                    } else {
                        tUser.followers.push(currentUser.username);
                    }
                }

                // Save optimism
                localStorage.setItem('user_session', JSON.stringify(currentUser));
                render(); // Re-render immediately

                // DB Update
                if (isFollowing) {
                    await updateDoc(myRef, { following: arrayRemove(targetUsername) });
                    await updateDoc(targetRef, { followers: arrayRemove(currentUser.username) });
                } else {
                    await updateDoc(myRef, { following: arrayUnion(targetUsername) });
                    await updateDoc(targetRef, { followers: arrayUnion(currentUser.username) });
                }
            } catch (e) {
                console.error("Follow failed", e);
                initApp(); // Reset logic on fail
            }
        }

        async function updateProfile(data) {
            await updateDoc(doc(db, "users", currentUser.username), data);
            currentUser = { ...currentUser, ...data };
            localStorage.setItem('user_session', JSON.stringify(currentUser));
            currentRoute = 'profile';
            render();
        }

        // --- Initialization ---

        function initApp() {
            if (unsubTweets) unsubTweets();
            const q = query(collection(db, "tweets"), orderBy("timestamp", "desc"));
            unsubTweets = onSnapshot(q, async (snapshot) => {
                tweets = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // Cache authors
                const authors = [...new Set(tweets.map(t => t.author))];
                await fetchUsers(authors);
                render();
            });

            if (unsubUser) unsubUser();
            unsubUser = onSnapshot(doc(db, "users", currentUser.username), (doc) => {
                if (doc.exists()) {
                    currentUser = doc.data();
                    localStorage.setItem('user_session', JSON.stringify(currentUser));
                    render();
                }
            });

            render();
        }

        async function fetchUsers(usernames) {
            const missing = usernames.filter(u => !usersCache[u]);
            if (missing.length === 0) return;
            // Batch fetch simplified for demo (one by one)
            await Promise.all(missing.map(async u => {
                const d = await getDoc(doc(db, "users", u));
                if (d.exists()) usersCache[u] = d.data();
            }));
        }

        // --- Rendering ---

        const root = document.getElementById('app');

        function render() {
            if (!currentUser) { renderAuth(); return; }

            root.className = "w-full max-w-[1300px] mx-auto flex h-screen overflow-hidden bg-black text-slate-200";
            root.innerHTML = '';

            root.appendChild(createSidebar());
            root.appendChild(createMain());
            root.appendChild(createWidgets());
        }

        function createSidebar() {
            const nav = document.createElement('nav');
            nav.className = "w-[80px] xl:w-[260px] h-full flex flex-col justify-between py-6 px-2 xl:px-4 border-r border-white/10 hidden md:flex shrink-0";
            
            const links = [
                { id: 'feed', icon: 'fa-house', label: 'Home', onclick: () => { currentRoute='feed'; render(); } },
                { id: 'profile', icon: 'fa-user', label: 'Profile', onclick: () => { profileTarget=currentUser.username; currentRoute='profile'; render(); } },
                { id: 'settings', icon: 'fa-paintbrush', label: 'Design', onclick: () => { currentRoute='settings'; render(); } },
            ];

            nav.innerHTML = `
                <div class="space-y-2 flex flex-col items-center xl:items-start">
                    <div class="p-3 mb-2 rounded-full hover:bg-white/10 transition cursor-pointer">
                        <i class="fa-brands fa-x-twitter text-3xl text-white"></i>
                    </div>
                    ${links.map(l => `
                        <button onclick="window.navTo('${l.id}')" class="group flex items-center gap-4 p-3 xl:pr-6 rounded-full transition hover:bg-white/10 ${currentRoute === l.id ? 'font-bold' : ''}">
                            <i class="fa-solid ${l.icon} text-2xl relative">
                                ${currentRoute === l.id ? '<div class="absolute -inset-2 bg-blue-500/20 blur-md rounded-full"></div>' : ''}
                            </i>
                            <span class="hidden xl:block text-xl">${l.label}</span>
                        </button>
                    `).join('')}
                    
                    <button id="postBtn" class="mt-8 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-4 xl:py-3 xl:px-8 shadow-lg shadow-blue-500/30 transition transform hover:scale-105">
                        <i class="fa-solid fa-feather xl:hidden text-xl"></i>
                        <span class="hidden xl:block font-bold text-lg">Post</span>
                    </button>
                </div>

                <div class="flex items-center gap-3 p-3 rounded-full hover:bg-white/10 cursor-pointer transition" onclick="logout()">
                    <img src="${currentUser.pfp}" class="w-10 h-10 rounded-full object-cover border border-white/20">
                    <div class="hidden xl:block overflow-hidden text-left">
                        <p class="font-bold text-sm truncate text-white">${currentUser.name}</p>
                        <p class="text-gray-500 text-xs truncate">@${currentUser.username}</p>
                    </div>
                </div>
            `;

            // Bind actions
            window.navTo = (id) => {
                const link = links.find(l => l.id === id);
                if (link) link.onclick();
            };
            
            nav.querySelector('#postBtn').onclick = () => {
                currentRoute = 'feed';
                render();
                setTimeout(() => document.getElementById('tweetInput')?.focus(), 100);
            };

            return nav;
        }

        function createMain() {
            const main = document.createElement('main');
            main.className = "flex-1 border-r border-white/10 overflow-y-auto scroll-smooth relative";
            
            // Router
            if (currentRoute === 'feed') main.appendChild(renderFeed());
            else if (currentRoute === 'profile') main.appendChild(renderProfile());
            else if (currentRoute === 'settings') main.appendChild(renderSettings());

            return main;
        }

        function createWidgets() {
            const aside = document.createElement('aside');
            aside.className = "w-[350px] hidden lg:block p-6 space-y-6";
            
            aside.innerHTML = `
                <div class="sticky top-4 space-y-6">
                    <div class="relative group">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-gray-500"></i>
                        <input type="text" placeholder="Search" class="w-full bg-slate-900 border border-transparent focus:border-blue-500 focus:bg-black rounded-full py-3 pl-12 pr-4 outline-none text-white transition placeholder-slate-500">
                    </div>

                    <div class="bg-slate-900/50 border border-white/5 rounded-2xl p-4">
                        <h3 class="font-bold text-xl mb-4 px-2">Who to follow</h3>
                        <div id="whoToFollow" class="space-y-4">
                             <div class="flex justify-center py-4"><span class="loader border-slate-500"></span></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load Suggestions
            setTimeout(async () => {
                const q = query(collection(db, "users"));
                const snap = await getDocs(q); // Fetch all (simplified)
                const list = aside.querySelector('#whoToFollow');
                const others = snap.docs.map(d => d.data())
                    .filter(u => u.username !== currentUser.username && !currentUser.following.includes(u.username))
                    .slice(0, 4);

                if(others.length === 0) list.innerHTML = `<div class="px-2 text-slate-500">No suggestions.</div>`;
                else {
                    list.innerHTML = others.map(u => `
                        <div class="flex items-center justify-between p-2 hover:bg-white/5 rounded-xl transition cursor-pointer" onclick="window.viewUser('${u.username}')">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <img src="${u.pfp}" class="w-10 h-10 rounded-full object-cover bg-slate-800">
                                <div class="min-w-0">
                                    <p class="font-bold hover:underline truncate">${u.name}</p>
                                    <p class="text-slate-500 text-sm truncate">@${u.username}</p>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); window.doFollow('${u.username}')" class="bg-white text-black text-sm font-bold px-4 py-1.5 rounded-full hover:bg-slate-200">Follow</button>
                        </div>
                    `).join('');
                }
            }, 500);

            return aside;
        }

        // --- View Pages ---

        function renderFeed() {
            const div = document.createElement('div');
            
            // Header
            div.innerHTML = `
                <div class="sticky top-0 z-30 bg-black/70 backdrop-blur-md border-b border-white/10 px-4 py-3 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <h2 class="text-lg font-bold">Home</h2>
                </div>
            `;

            // Composer
            const composer = document.createElement('div');
            composer.className = "p-4 border-b border-white/10";
            composer.innerHTML = `
                <div class="flex gap-4">
                    <img src="${currentUser.pfp}" class="w-10 h-10 rounded-full object-cover">
                    <div class="flex-1">
                        <textarea id="tweetInput" placeholder="What is happening?!" class="w-full bg-transparent text-xl text-white placeholder-slate-500 outline-none resize-none h-20 py-2"></textarea>
                        
                        <div id="previewImg" class="hidden relative mb-3 rounded-xl overflow-hidden border border-white/10">
                            <img class="w-full max-h-[300px] object-cover">
                            <button onclick="clearComposerImg()" class="absolute top-2 right-2 bg-black/50 p-1 rounded-full text-white hover:bg-black/80"><i class="fa-solid fa-xmark w-6 h-6 flex items-center justify-center"></i></button>
                        </div>

                        <div class="flex justify-between items-center border-t border-white/10 pt-3">
                            <div class="text-blue-400 flex gap-2">
                                <label class="p-2 hover:bg-blue-500/10 rounded-full cursor-pointer transition">
                                    <i class="fa-regular fa-image"></i>
                                    <input type="file" accept="image/*" onchange="handleComposerImg(this)">
                                </label>
                            </div>
                            <button onclick="submitPost()" class="bg-blue-500 text-white font-bold px-5 py-1.5 rounded-full hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">Post</button>
                        </div>
                    </div>
                </div>
            `;
            div.appendChild(composer);

            // Feed
            const feedList = document.createElement('div');
            const relevant = tweets.filter(t => t.author === currentUser.username || currentUser.following.includes(t.author));
            
            if (relevant.length === 0) {
                feedList.innerHTML = `
                    <div class="p-10 text-center">
                        <h3 class="text-2xl font-bold mb-2">Welcome to Ultra</h3>
                        <p class="text-slate-500">Find people to follow in the sidebar.</p>
                    </div>`;
            } else {
                relevant.forEach(t => feedList.appendChild(createTweet(t)));
            }
            div.appendChild(feedList);

            return div;
        }

        function createTweet(t) {
            const author = usersCache[t.author] || { name: t.author, username: t.author, pfp: '', color: '#fff' };
            const el = document.createElement('div');
            el.className = "p-4 border-b border-white/10 hover:bg-white/[0.02] transition cursor-pointer";
            
            // Styling
            let nameStyle = `color: ${author.color}`;
            let nameClasses = `font-bold hover:underline mr-1 ${author.effect !== 'none' ? 'effect-'+author.effect : ''}`;
            if (author.gradient && author.gradient !== 'none') {
                const g = GRADIENTS.find(x => x.id === author.gradient);
                if (g) {
                    nameClasses += ` ${g.class} text-transparent bg-clip-text`;
                    nameStyle = '';
                }
            }

            const isLiked = t.likes?.includes(currentUser.username);
            const commentCount = t.comments?.length || 0;

            el.innerHTML = `
                <div class="flex gap-4">
                    <img src="${author.pfp}" class="w-10 h-10 rounded-full object-cover hover:opacity-80 transition stop-prop" onclick="window.viewUser('${t.author}')">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline flex-wrap">
                            <span class="${nameClasses}" style="${nameStyle}" data-text="${author.name}" onclick="window.viewUser('${t.author}')" class="stop-prop cursor-pointer">${author.name}</span>
                            <span class="text-slate-500 text-sm">@${author.username} Â· ${timeAgo(t.timestamp)}</span>
                        </div>
                        <p class="text-slate-100 mt-1 whitespace-pre-wrap leading-relaxed">${linkify(t.content)}</p>
                        ${t.image ? `<div class="mt-3 rounded-xl overflow-hidden border border-white/10 max-h-[500px]"><img src="${t.image}" class="w-full object-cover"></div>` : ''}
                        
                        <div class="flex justify-between mt-3 max-w-sm text-slate-500">
                            <button onclick="window.toggleComments('${t.id}')" class="flex items-center gap-2 group hover:text-blue-400 transition stop-prop">
                                <div class="p-2 rounded-full group-hover:bg-blue-500/10"><i class="fa-regular fa-comment"></i></div>
                                <span class="text-xs">${commentCount}</span>
                            </button>
                            <button class="flex items-center gap-2 group hover:text-green-400 transition stop-prop">
                                <div class="p-2 rounded-full group-hover:bg-green-500/10"><i class="fa-solid fa-retweet"></i></div>
                            </button>
                            <button onclick="window.likePost('${t.id}')" class="flex items-center gap-2 group hover:text-pink-500 transition stop-prop ${isLiked ? 'text-pink-500' : ''}">
                                <div class="p-2 rounded-full group-hover:bg-pink-500/10"><i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart"></i></div>
                                <span class="text-xs">${t.likes?.length || 0}</span>
                            </button>
                        </div>

                        <!-- Comments Section -->
                        <div id="comments-${t.id}" class="hidden mt-4 pt-3 border-t border-white/10 stop-prop">
                            <div class="space-y-4 mb-4">
                                ${(t.comments || []).map(c => {
                                    const cAuth = usersCache[c.author] || { name: c.author };
                                    return `
                                    <div class="flex gap-3">
                                        <div class="font-bold text-sm text-slate-300">${cAuth.name}</div>
                                        <div class="text-sm text-slate-400">${c.content}</div>
                                    </div>`;
                                }).join('')}
                                ${(t.comments || []).length === 0 ? '<div class="text-slate-600 text-sm">No comments yet.</div>' : ''}
                            </div>
                            <div class="flex gap-3">
                                <img src="${currentUser.pfp}" class="w-8 h-8 rounded-full">
                                <input type="text" id="comment-input-${t.id}" placeholder="Post your reply" class="bg-transparent border-none outline-none text-white placeholder-slate-600 flex-1 text-sm" onkeydown="if(event.key === 'Enter') window.postComment('${t.id}')">
                                <button onclick="window.postComment('${t.id}')" class="text-blue-400 text-sm font-bold">Reply</button>
                            </div>
                        </div>

                    </div>
                </div>
            `;
            el.querySelectorAll('.stop-prop').forEach(b => b.addEventListener('click', e => e.stopPropagation()));
            return el;
        }

        function renderProfile() {
            const user = (profileTarget === currentUser.username) ? currentUser : (usersCache[profileTarget] || { username: profileTarget, name: '...', pfp: '', banner: '' });
            
            // Load if missing
            if (user.name === '...') fetchUsers([profileTarget]).then(() => { if(currentRoute === 'profile') render(); });

            const isMe = user.username === currentUser.username;
            const isFollowing = currentUser.following.includes(user.username);

            const div = document.createElement('div');
            
            // Sticky Header
            div.innerHTML = `
                <div class="sticky top-0 z-20 bg-black/70 backdrop-blur-md px-4 py-2 border-b border-white/10 flex items-center gap-4">
                    <button onclick="currentRoute='feed'; render()" class="p-2 hover:bg-white/10 rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                    <div>
                        <h2 class="font-bold text-lg leading-tight">${user.name}</h2>
                        <p class="text-xs text-slate-500">${tweets.filter(t => t.author === user.username).length} posts</p>
                    </div>
                </div>
            `;

            // Banner
            div.innerHTML += `
                <div class="h-48 w-full bg-slate-800 overflow-hidden relative">
                    ${user.banner ? `<img src="${user.banner}" class="w-full h-full object-cover">` : ''}
                </div>
            `;

            // Details
            let nameClasses = `text-2xl font-black ${user.effect !== 'none' ? 'effect-'+user.effect : ''}`;
            let nameStyle = `color: ${user.color}`;
            if (user.gradient && user.gradient !== 'none') {
                const g = GRADIENTS.find(x => x.id === user.gradient);
                if (g) { nameClasses += ` ${g.class} text-transparent bg-clip-text`; nameStyle = ''; }
            }

            const info = document.createElement('div');
            info.className = "px-4 pb-4 relative border-b border-white/10";
            info.innerHTML = `
                <div class="flex justify-between items-start -mt-[4rem] mb-3">
                    <div class="relative p-1 bg-black rounded-full">
                        <img src="${user.pfp}" class="w-32 h-32 rounded-full object-cover border-4 border-black bg-slate-800">
                    </div>
                    <div class="mt-[4.5rem]">
                        ${isMe 
                            ? `<button onclick="currentRoute='settings'; render()" class="border border-white/20 font-bold px-4 py-1.5 rounded-full hover:bg-white/10 transition">Edit profile</button>` 
                            : `<button onclick="window.doFollow('${user.username}')" class="${isFollowing ? 'border border-white/20 text-white hover:border-red-500/50 hover:text-red-500 hover:bg-red-500/10' : 'bg-white text-black hover:opacity-90'} font-bold px-5 py-1.5 rounded-full transition min-w-[100px]">${isFollowing ? 'Following' : 'Follow'}</button>`
                        }
                    </div>
                </div>
                <div>
                    <h2 class="${nameClasses}" style="${nameStyle}" data-text="${user.name}">${user.name}</h2>
                    <p class="text-slate-500 text-sm mb-3">@${user.username}</p>
                    <p class="text-white mb-3 whitespace-pre-wrap">${linkify(user.bio || "")}</p>
                    <div class="flex gap-4 text-slate-500 text-sm mb-3">
                        <span><i class="fa-regular fa-calendar mr-1"></i> Joined ${new Date(user.joined).toLocaleDateString()}</span>
                    </div>
                    <div class="flex gap-4 text-sm">
                        <span class="text-white font-bold">${user.following?.length || 0} <span class="text-slate-500 font-normal">Following</span></span>
                        <span class="text-white font-bold">${user.followers?.length || 0} <span class="text-slate-500 font-normal">Followers</span></span>
                    </div>
                </div>
            `;
            div.appendChild(info);

            // User's Tweets
            const userPosts = tweets.filter(t => t.author === user.username);
            userPosts.forEach(t => div.appendChild(createTweet(t)));
            if (userPosts.length === 0) div.innerHTML += `<div class="p-8 text-center text-slate-500">No posts yet.</div>`;

            return div;
        }

        function renderSettings() {
            const div = document.createElement('div');
            div.className = "max-w-2xl mx-auto min-h-screen bg-black";

            // Header
            div.innerHTML = `
                <div class="sticky top-0 z-20 bg-black/80 backdrop-blur-md px-4 py-3 flex items-center gap-4 border-b border-white/10">
                    <button onclick="currentRoute='profile'; render()" class="p-2 hover:bg-white/10 rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                    <h2 class="text-xl font-bold">Edit Profile</h2>
                </div>
            `;

            const content = document.createElement('div');
            content.className = "p-4 space-y-6 pb-20";

            // 1. Images Section
            const imagesCard = document.createElement('div');
            imagesCard.className = "border border-white/10 rounded-2xl overflow-hidden";
            imagesCard.innerHTML = `
                <div class="h-32 bg-slate-800 relative group cursor-pointer" onclick="document.getElementById('bannerUpload').click()">
                    <img id="editBannerPreview" src="${currentUser.banner || ''}" class="w-full h-full object-cover opacity-60 group-hover:opacity-40 transition">
                    <div class="absolute inset-0 flex items-center justify-center text-white/50 group-hover:text-white transition font-bold"><i class="fa-solid fa-camera mr-2"></i> Edit Banner</div>
                    <input type="file" id="bannerUpload" accept="image/*" onchange="window.handleEditFile(this, 'banner')">
                </div>
                <div class="px-4 pb-4 -mt-10 relative pointer-events-none">
                    <div class="relative w-24 h-24 rounded-full overflow-hidden border-4 border-black bg-slate-700 group cursor-pointer pointer-events-auto" onclick="document.getElementById('pfpUpload').click()">
                        <img id="editPfpPreview" src="${currentUser.pfp}" class="w-full h-full object-cover opacity-80 group-hover:opacity-60 transition">
                        <div class="absolute inset-0 flex items-center justify-center text-white/50 group-hover:text-white transition"><i class="fa-solid fa-camera"></i></div>
                        <input type="file" id="pfpUpload" accept="image/*" onchange="window.handleEditFile(this, 'pfp')">
                    </div>
                </div>
            `;
            content.appendChild(imagesCard);

            // 2. Info Section
            const infoCard = document.createElement('div');
            infoCard.className = "space-y-4";
            infoCard.innerHTML = `
                <div>
                    <label class="block text-sm text-slate-500 mb-1 ml-1">Name</label>
                    <input id="editName" type="text" value="${currentUser.name}" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 outline-none text-white transition" oninput="window.updateEditPreview()">
                </div>
                <div>
                    <label class="block text-sm text-slate-500 mb-1 ml-1">Bio</label>
                    <textarea id="editBio" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 outline-none text-white transition h-24 resize-none">${currentUser.bio || ''}</textarea>
                </div>
            `;
            content.appendChild(infoCard);

            // 3. Visuals (Grid) - LEFT ALIGNED
            const visualsCard = document.createElement('div');
            visualsCard.className = "space-y-6 pt-4 border-t border-white/10";
            
            // Name Preview (Left Aligned)
            visualsCard.innerHTML = `
                <div class="bg-slate-900/50 rounded-xl p-4 text-left flex flex-col items-start border border-white/5 sticky top-20 z-10 backdrop-blur-xl">
                    <div class="text-xs text-slate-500 uppercase font-bold mb-2">Name Preview</div>
                    <span id="namePreview" class="text-3xl font-black block">${currentUser.name}</span>
                </div>
            `;

            // Colors
            visualsCard.innerHTML += `
                <div>
                    <h3 class="font-bold mb-3">Accent Color</h3>
                    <div class="flex flex-wrap gap-3">
                        ${COLORS.map(c => `
                            <div onclick="window.setEditStyle('color', '${c}')" class="w-10 h-10 rounded-full cursor-pointer hover:scale-110 transition border-2 border-transparent hover:border-white" style="background:${c}"></div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Gradients
            visualsCard.innerHTML += `
                <div>
                    <h3 class="font-bold mb-3">Gradient Text</h3>
                    <div class="grid grid-cols-2 gap-3">
                        ${GRADIENTS.map(g => `
                            <div onclick="window.setEditStyle('gradient', '${g.id}')" class="h-12 rounded-lg cursor-pointer border border-white/10 flex items-center justify-center font-bold text-sm ${g.class} ${g.id === 'none' ? 'bg-slate-800' : ''}">
                                ${g.label}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Effects
            visualsCard.innerHTML += `
                <div>
                    <h3 class="font-bold mb-3">Effects</h3>
                    <div class="grid grid-cols-2 gap-3">
                        ${EFFECTS.map(e => `
                            <div onclick="window.setEditStyle('effect', '${e.id}')" class="p-3 rounded-lg cursor-pointer border border-white/10 hover:border-blue-500 text-center bg-slate-900/50">
                                <span class="font-bold ${e.id !== 'none' ? 'effect-'+e.id : ''}" data-text="${e.label}">${e.label}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            content.appendChild(visualsCard);

            // Save Button
            const saveBtn = document.createElement('button');
            saveBtn.className = "w-full bg-white text-black font-bold py-3 rounded-full hover:bg-slate-200 transition sticky bottom-6 shadow-[0_0_20px_rgba(255,255,255,0.2)]";
            saveBtn.innerText = "Save";
            saveBtn.onclick = async () => {
                saveBtn.disabled = true;
                saveBtn.innerText = "Saving...";
                const name = document.getElementById('editName').value;
                const bio = document.getElementById('editBio').value;
                const banner = document.getElementById('editBannerPreview').src;
                const pfp = document.getElementById('editPfpPreview').src;
                
                await updateProfile({ name, bio, banner, pfp, ...editStyle });
            };
            content.appendChild(saveBtn);

            div.appendChild(content);

            // Logic
            window.editStyle = { color: currentUser.color, gradient: currentUser.gradient, effect: currentUser.effect };
            
            window.handleEditFile = async (input, type) => {
                if(input.files[0]) {
                    const b64 = await fileToBase64(input.files[0]);
                    document.getElementById(type === 'banner' ? 'editBannerPreview' : 'editPfpPreview').src = b64;
                }
            }

            window.setEditStyle = (key, val) => {
                window.editStyle[key] = val;
                if(key === 'color') window.editStyle.gradient = 'none';
                if(key === 'gradient' && val !== 'none') window.editStyle.color = '#fff';
                window.updateEditPreview();
            }

            window.updateEditPreview = () => {
                const el = document.getElementById('namePreview');
                el.innerText = document.getElementById('editName').value;
                el.setAttribute('data-text', el.innerText);
                el.className = `text-3xl font-black block transition-all ${window.editStyle.effect !== 'none' ? 'effect-'+window.editStyle.effect : ''}`;
                el.style.color = '';

                if(window.editStyle.gradient !== 'none') {
                    const g = GRADIENTS.find(x => x.id === window.editStyle.gradient);
                    el.classList.add(...g.class.split(' '), 'text-transparent', 'bg-clip-text');
                } else {
                    el.style.color = window.editStyle.color;
                }
            }

            setTimeout(window.updateEditPreview, 50);

            return div;
        }

        // --- Auth UI ---

        function renderAuth() {
            const div = document.createElement('div');
            div.className = "w-full max-w-md p-8 pt-20 flex flex-col items-center animate-fade-in";
            div.innerHTML = `
                <i class="fa-brands fa-x-twitter text-6xl text-white mb-8"></i>
                <h1 class="text-3xl font-bold mb-8">Happening now</h1>
                
                <form id="authForm" class="w-full space-y-4">
                    <div id="signupName" class="hidden">
                        <input type="text" name="name" placeholder="Name" class="w-full bg-black border border-white/20 rounded px-4 py-3 outline-none focus:border-blue-500 text-white">
                    </div>
                    <input type="text" name="username" placeholder="Username" class="w-full bg-black border border-white/20 rounded px-4 py-3 outline-none focus:border-blue-500 text-white" required>
                    <input type="password" name="password" placeholder="Password" class="w-full bg-black border border-white/20 rounded px-4 py-3 outline-none focus:border-blue-500 text-white" required>
                    
                    <button type="submit" class="w-full bg-white text-black font-bold rounded-full py-3 hover:bg-slate-200 transition mt-4" id="submitAuth">Log in</button>
                </form>

                <div class="mt-8 text-slate-500">
                    <span id="authToggleText">Don't have an account?</span>
                    <button class="text-blue-400 hover:underline ml-1" onclick="window.toggleAuthMode()">Sign up</button>
                </div>
            `;

            let isSignup = false;
            window.toggleAuthMode = () => {
                isSignup = !isSignup;
                document.getElementById('signupName').classList.toggle('hidden', !isSignup);
                document.getElementById('submitAuth').innerText = isSignup ? 'Sign up' : 'Log in';
                document.getElementById('authToggleText').innerText = isSignup ? 'Have an account?' : "Don't have an account?";
            };

            div.querySelector('form').onsubmit = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = Object.fromEntries(fd);
                const res = isSignup 
                    ? await signup(data.username, data.password, data.name) 
                    : await login(data.username, data.password);
                
                if(res.error) alert(res.error);
            };

            root.innerHTML = '';
            root.className = "min-h-screen bg-black text-white flex justify-center";
            root.appendChild(div);
        }

        // --- Helpers Global ---
        window.navTo = () => {}; 
        window.viewUser = (u) => { profileTarget = u; currentRoute = 'profile'; render(); };
        window.doFollow = (u) => toggleFollow(u);
        window.likePost = async (id) => {
            const ref = doc(db, "tweets", id);
            const t = tweets.find(x => x.id === id);
            if(!t) return;
            const liked = t.likes.includes(currentUser.username);
            await updateDoc(ref, { likes: liked ? arrayRemove(currentUser.username) : arrayUnion(currentUser.username) });
        };
        
        window.handleComposerImg = async (input) => {
            if(input.files[0]) {
                const b64 = await fileToBase64(input.files[0]);
                const prev = document.getElementById('previewImg');
                prev.classList.remove('hidden');
                prev.querySelector('img').src = b64;
            }
        };
        window.clearComposerImg = () => {
             document.getElementById('previewImg').classList.add('hidden');
             document.querySelector('input[type="file"]').value = '';
        };
        window.submitPost = async () => {
            const txt = document.getElementById('tweetInput').value;
            const imgEl = document.getElementById('previewImg');
            const img = (!imgEl.classList.contains('hidden')) ? imgEl.querySelector('img').src : null;
            await postTweet(txt, img);
            currentRoute = 'feed'; render();
        };

        // NEW COMMENT HELPERS
        window.toggleComments = (id) => {
            document.getElementById(`comments-${id}`).classList.toggle('hidden');
        };
        window.postComment = async (id) => {
            const input = document.getElementById(`comment-input-${id}`);
            await addComment(id, input.value);
            input.value = '';
        };

        function linkify(text) {
            return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-400 hover:underline" onclick="event.stopPropagation()">$1</a>');
        }

        function timeAgo(d) {
            const s = Math.floor((new Date() - new Date(d)) / 1000);
            if(s < 60) return s + 's';
            if(s < 3600) return Math.floor(s/60) + 'm';
            if(s < 86400) return Math.floor(s/3600) + 'h';
            return new Date(d).toLocaleDateString();
        }

        // Start
        if (currentUser) initApp();
        else renderAuth();

    </script>
</body>
</html>
